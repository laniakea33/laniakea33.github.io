---
title: "Naver Tech Conconcert - 01"
categories:
    - Android
---
안드로이드 앱은 초당 60개의 프레임을 그린다. 즉 개당 16ms만에 화면을 갱신해야 하며 그렇지 못하면 프레임 드랍이 발생하게 되는데,
이 때 사용자는 앱이 버벅거림을 느끼게 된다. 화면에 View를 그리는 작업을 렌더링이라고 하는데, 대략 다음과 같은 과정으로 진행된다.

뷰가 화면에 그려지는 과정
1. 뷰가 CPU에 의해 폴리곤-메시와 텍스처로 변환
대부분의 3차원 컴퓨터 그래픽스는 폴리곤이라는 삼각형으로 구성되며 폴리곤들의 집합을 폴리곤 메시라고 부른다. 폴리곤 메시에
폴리곤이 많을 수록 세밀한 표현이 가능하다. CPU는 연산을 통해 3차원 폴리곤 메시를 만든 후 질감(텍스처)을 입히는 작업을 한다
(UV매핑).

2. 변환된 데이터는 OpenGL에 의해 CPU에서 GPU로 전달
안드로이드 기기에는 GPU가 포함되어 있어 3차원 그래픽을 병렬로 처리한다. 따라서 위에서 만든 데이터를 CPU에서 GPU로 전달해야 하는 데
이 때 OpenGL|ES라는 라이브러리를 사용한다. 이 라이브러리는 데이터를 보존하고, 재사용함으로써 성능을 높이는 데 도움을 준다.
즉 GPU메모리에 적재된 데이터를 재사용하는 것이 랜더링 성능의 핵심이다.

3. 래스터화를 거쳐 화면에 나타남 
안드로이드는 텍스트, 버튼과 같은 이미지를 '레스터화'를 통해 화면에 보여주게 되는데, 이 과정은 일반적으로 비용이 크기 때문에 GPU가 담당한다.
GPU는 전달받은 폴리곤과 텍스처를 사용해 래스터화를 진행하고, 이를 통해 프레임을 만들어 화면에 나타낸다.



View의 성능을 올리는 꿀팁 들
* Overdraw(같은 픽셀을 불필요하게 여러번 덧칠하는 것)를 줄이는 것
1. 불필요하게 같은 배경색을 가진 뷰를 겹치지 않게
2. 투명도 사용을 삼가하기
회색과 반투명 검정은 보기에는 똑같지만 반투명의 경우는 부가적인 연산을 필요로 한다.
3. 생명주기에서 갱신 빈도 낮추기
커스텀뷰 제작시 불필요한 invalidate는 하지 않고, onDraw, OnMeasure, OnLayout이 자주 호출되지 않도록 한다.
onDraw에서 객체를 메모리에 할당하거나 초기화 하는 작업은 삼가할 것.
4. 뷰 계층 평탄화 하기
레이아웃이 깊을 수록 연산량이 기하급수적으로 증가하는데, 대신 ConstraintLayout을 사용하면 좋다.
5. ViewStub사용으로 느리게 초기화 하기
초기화 지연, 경량화된 View로 보이지 않고, 아무것도 그리지 않음, 복잡한 레이아웃에서 사용.
6. RecyclerView퍼포먼스 향상
* 아이템 갱신 최소화 하기(notifyDataSetChanged() 대신 notifyItemChanged()등 부분 갱신 메소드 사용)
* DiffUtil클래스 사용하여 아이템의 변경을 명시
* setHasFixedSize = true : RecyclerView의 크기가 Adapter에 의존하지 않는다는것을 명시함으로써 데이터 변경시 Layout을 갱신하지 않도록 한다
* setItemViewCacheSize = true <- 아이템 뷰가 풀로 들어가기 전에 유지되는 캐시 사이즈 결정, View가 사라졌다 나타나도 새로 바인딩 하지 않도록 한다.
* setRecycledViewPool = true <- 중첩된 리사이클러 뷰를 사용하는 경우 아이템 풀을 공유하도록 한다.
* setHasStableIds = true <- 아이템에 대해 고유식별자를 부여하여 동일한 아이템에 대해 OnBind...호출을 방지하여 성능을 개선한다.



* 앱 성능 개선을 위한 도구
1. Layout Inspector <- 런타임에서 레이아웃 확인 가능
2. Profiler <- 앱이 버벅거릴 때 CPU의 메인스레드를 확인해 볼것
3. Lint <- 기본제공되는 정적 코드 스캔도구. 여러 상황에서 경고를 띄울 수 있다.(Preferences -> Inspections에서 설정)
4. 개발자 옵션의 Gpu랜더링 프로파일링 활성화. 각 프레임당 렌더링에 걸린 시간을 보여줌..
5. 개발자 옵션의 하드웨어 가속 렌더링 > GPU오버드로우 디버그 활성화. 오버드로우 된 픽셀을 볼 수 있음.